<!-- =======================  PALBI Calculator – Improved v2025‑05  ======================= -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>長崎大学肝臓外科版 PALBI計算ツール v2025‑05</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
 :root{
   --c1:#0066cc;--c2:#4caf50;--c3:#ff9800;--c4:#f44336;
   font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif
 }
 body{max-width:720px;margin:auto;padding:1.5rem}
 h1{color:var(--c1);text-align:center;font-size:1.6rem;margin:0 0 1rem}
 nav{display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:1rem}
 nav button{flex:1 1 120px;border:1px solid var(--c1);background:#fff;color:var(--c1);padding:.4rem;border-radius:4px;cursor:pointer}
 nav button.active{background:var(--c1);color:#fff}
 label{display:block;margin-top:.8rem}
 input{width:160px;padding:.3rem}
 #calcBtn{margin-top:1rem;padding:.5rem 1.2rem;background:var(--c1);color:#fff;border:none;border-radius:4px;cursor:pointer}
 #zones{margin-top:1rem;text-align:center}
 .zone{display:inline-block;width:30%;padding:.4rem;font-weight:bold;color:#fff;border-radius:4px}
 #z1{background:var(--c2)}#z2{background:var(--c3)}#z3{background:var(--c4)}.active{box-shadow:0 0 14px 4px #000}
 table{border-collapse:collapse;margin-top:.4rem;width:100%}
 td,th{border:1px solid #ccc;padding:.3rem;text-align:center;font-size:.9rem}
 #tblCaption{margin-top:.6rem;font-size:.85rem;color:#333}
 #histNav{display:flex;align-items:center;justify-content:center;gap:.6rem;margin:.6rem 0}
 #histNav button{border:1px solid var(--c1);background:#fff;color:var(--c1);padding:.2rem .6rem;border-radius:4px;cursor:pointer;min-width:64px}
 #histNav button:disabled{opacity:.4;cursor:default}
 footer{margin-top:1.5rem;font-size:.8rem;text-align:center;color:#555}
 @media print{nav,#calcBtn,#histNav{display:none}}
</style>
</head>
<body>
<h1 id="title">PALBI 計算ツール</h1>

<nav>
  <button data-page="calc"   class="active">計算</button>
  <button data-page="about">PALBIとは</button>
  <button data-page="refs">参考文献</button>
  <button data-page="history">履歴</button>
  <button id="langBtn">English</button>
</nav>

<!-- ===== 計算 ===== -->
<section id="calc" class="page">
  <label id="lb-bili">総ビリルビン (mg/dL): <input type="number" id="bili" step="0.1"></label>
  <label id="lb-alb">アルブミン (g/dL): <input type="number" id="alb" step="0.1"></label>
  <label id="lb-plt">血小板数 (万/µL): <input type="number" id="plt" step="1"></label>
  <button id="calcBtn">計算</button>

  <div id="result" style="margin-top:1rem;font-size:1.1rem"></div>

  <div id="zones">
    <div class="zone" id="z1">低値</div><div class="zone" id="z2">中間</div><div class="zone" id="z3">高値</div>
  </div>
</section>

<!-- ===== PALBIとは ===== -->
<section id="about" class="page" hidden>
  <p id="about-text">
    PALBI (Platelet‑Albumin‑Bilirubin) スコアは、肝障害の重症度や予後を評価する指標です。<br>
    血小板・アルブミン・ビリルビンの 3 項目で算出し、値が低いほど肝機能が良好とされます。
  </p>
</section>

<!-- ===== References ===== -->
<section id="refs" class="page" hidden>
  <ol style="font-size:.9rem">
    <li>Liu P‑H <em>et al.</em> Prognostic utility of the PALBI score for hepatocellular carcinoma resection. <em>J Gastroenterol Hepatol</em>. 2017;32:879‑886.</li>
    <li>Zhu M <em>et al.</em> PALBI stratification in cirrhosis. <em>Eur J Gastroenterol Hepatol</em>. 2020;32:1698‑1705.</li>
    <li>Lee S‑K <em>et al.</em> Validating PALBI in Asian cohorts. <em>PLoS ONE</em>. 2019;14:e0216173.</li>
  </ol>
</section>

<!-- ===== 履歴 ===== -->
<section id="history" class="page" hidden>
  <div id="histNav"><button id="prevHist">&lt; Prev</button><span id="histRange"></span><button id="nextHist">Next &gt;</button></div>
  <ol id="histList" style="font-size:.9rem"></ol>

  <!-- Moved stats caption & table here -->
  <p id="tblCaption" hidden>ログイン履歴・計算履歴および平均値</p>
  <table id="statsTable" hidden>
    <thead><tr><th></th><th id="th-vis">ログイン履歴</th><th id="th-calc">計算履歴</th><th id="th-avg">平均</th></tr></thead>
    <tbody>
      <tr><td id="td-bili">ビリルビン</td><td colspan="2"></td><td id="avgBili"></td></tr>
      <tr><td id="td-alb">アルブミン</td><td colspan="2"></td><td id="avgAlb"></td></tr>
      <tr><td id="td-plt">血小板数</td><td colspan="2"></td><td id="avgPlt"></td></tr>
      <tr><td>PALBI</td><td id="vCount"></td><td id="cCount"></td><td id="avgScore"></td></tr>
    </tbody>
  </table>

  <p id="avgCaption" style="font-size:.85rem;color:#333;margin-top:.6rem">計算回数あたりの平均値</p>
  <table id="avgTable" hidden>
    <thead><tr><th></th><th id="th-avgBili">ビリルビン</th><th id="th-avgAlb">アルブミン</th><th id="th-avgPlt">血小板数</th><th id="th-avgScore">PALBI</th></tr></thead>
    <tbody>
      <tr><td id="td-labelAvg">平均</td><td id="avgBili2"></td><td id="avgAlb2"></td><td id="avgPlt2"></td><td id="avgScore2"></td></tr>
    </tbody>
  </table>
</section>

<footer>
  長崎大学肝臓外科版 PALBI計算ツール v2025‑05<br>
  © 福本将之、江口 晋
</footer>

<script>
/* ---------- Text dictionary ---------- */
const TXT={
  jp:{menu:{calc:"計算",about:"PALBIとは",refs:"参考文献",history:"履歴"},
      title:"PALBI 計算ツール",
      labels:{bili:"総ビリルビン (mg/dL):",alb:"アルブミン (g/dL):",plt:"血小板数 (万/µL):"},
      btnCalc:"計算",low:"低値",mid:"中間",high:"高値",
      about:`PALBI (Platelet‑Albumin‑Bilirubin) スコアは、肝障害の重症度や予後を評価する指標です。<br>血小板・アルブミン・ビリルビンの 3 項目で算出し、値が低いほど肝機能が良好とされます。`,
      tbl:{login:"ログイン履歴",calc:"計算履歴",avg:"平均",bili:"ビリルビン",alb:"アルブミン",plt:"血小板数",avgCaption:"計算回数あたりの平均値"},
      histNav:{prev:"< 前",next:"次 >",range:(a,b,c)=>`${a}-${b} / ${c}`},
      langBtn:"English",
      alertFill:"値を全て入力してください"
  },
  en:{menu:{calc:"Calculator",about:"About PALBI",refs:"References",history:"History"},
      title:"PALBI Calculator",
      labels:{bili:"Total Bilirubin (mg/dL):",alb:"Albumin (g/dL):",plt:"Platelets (×10³/µL):"},
      btnCalc:"Calculate",low:"Low",mid:"Intermediate",high:"High",
      about:`The Platelet‑Albumin‑Bilirubin (PALBI) score assesses liver dysfunction and prognosis.<br>It is calculated from platelet count, albumin, and bilirubin; lower scores indicate better hepatic reserve.`,
      tbl:{login:"Visits",calc:"Calculations",avg:"Average",bili:"Bilirubin",alb:"Albumin",plt:"Platelets",avgCaption:"Averages per calculation"},
      histNav:{prev:"< Prev",next:"Next >",range:(a,b,c)=>`${a}-${b} / ${c}`},
      langBtn:"日本語",
      alertFill:"Please fill all fields"
  }
};

/* ---------- Initialization ---------- */
let lang=localStorage.getItem("palbiLang")||"jp";
let currentHistPage=0; // 0 = newest
renderUI();

/* ---------- Page switching ---------- */
document.querySelectorAll("nav button[data-page]").forEach(b=>{
  b.addEventListener("click",()=>switchPage(b.dataset.page));
});
function switchPage(p){
  document.querySelectorAll(".page").forEach(s=>s.hidden=true);
  document.getElementById(p).hidden=false;
  document.querySelectorAll("nav button[data-page]").forEach(b=>b.classList.toggle("active",b.dataset.page===p));
  if(p==="history"){updateHistory();}
}

/* ---------- Language switching ---------- */
document.getElementById("langBtn").onclick=()=>{
  lang=lang==="jp"?"en":"jp";
  localStorage.setItem("palbiLang",lang);
  renderUI();
};
function renderUI(){
  const T=TXT[lang];
  // nav titles
  const mbtn=document.querySelectorAll("nav button[data-page]");
  ["calc","about","refs","history"].forEach((k,i)=>mbtn[i].textContent=T.menu[k]);
  document.getElementById("title").textContent=T.title;
  // labels
  document.getElementById("lb-bili").childNodes[0].nodeValue=T.labels.bili+" ";
  document.getElementById("lb-alb").childNodes[0].nodeValue=T.labels.alb+" ";
  document.getElementById("lb-plt").childNodes[0].nodeValue=T.labels.plt+" ";
  document.getElementById("calcBtn").textContent=T.btnCalc;
  document.getElementById("z1").textContent=T.low;
  document.getElementById("z2").textContent=T.mid;
  document.getElementById("z3").textContent=T.high;
  document.getElementById("about-text").innerHTML=T.about;
  // table headers & caption
  document.getElementById("th-vis").textContent=T.tbl.login;
  document.getElementById("th-calc").textContent=T.tbl.calc;
  document.getElementById("th-avg").textContent=T.tbl.avg;
  document.getElementById("td-bili").textContent=T.tbl.bili;
  document.getElementById("td-alb").textContent=T.tbl.alb;
  document.getElementById("td-plt").textContent=T.tbl.plt;
  document.getElementById("tblCaption").textContent=`${T.tbl.login}・${T.tbl.calc} ${T.tbl.avg}`;
  // history avg caption
  document.getElementById("avgCaption").textContent=T.tbl.avgCaption;
  // history nav buttons & range (range updated later)
  document.getElementById("prevHist").textContent=T.histNav.prev;
  document.getElementById("nextHist").textContent=T.histNav.next;
  // language toggle
  document.getElementById("langBtn").textContent=T.langBtn;
  // Update numbers in tables
  updateStats();
  if(!document.getElementById("history").hidden) updateHistory();
}

/* ---------- Stats & History storage ---------- */
const keyHist="palbiHist",keyStat="palbiStat";
let history=JSON.parse(localStorage.getItem(keyHist)||"[]");
let stat=JSON.parse(localStorage.getItem(keyStat)||"{}");
stat.visits=(stat.visits||0)+1;saveStat();
function saveStat(){localStorage.setItem(keyStat,JSON.stringify(stat));}
function saveHist(){localStorage.setItem(keyHist,JSON.stringify(history));}

/* ---------- Calculation ---------- */
document.getElementById("calcBtn").onclick=()=>{
  const bili=parseFloat(document.getElementById("bili").value),
        alb =parseFloat(document.getElementById("alb").value),
        plt =parseFloat(document.getElementById("plt").value);
  if([bili,alb,plt].some(isNaN)){
    alert(TXT[lang].alertFill);
    return;
  }
  // Convert units
  const bili_umol=bili*17.1, alb_gL=alb*10, plt_1000=plt*10;
  // PALBI formula
  const logB=Math.log10(bili_umol), logP=Math.log10(plt_1000);
  const palbi=2.02*logB-0.37*logB**2-0.04*alb_gL-3.48*logP+1.01*logP**2;
  const score=parseFloat(palbi.toFixed(2)), grade=score<=-2.53?1:score<=-2.09?2:3;
  // Result
  document.getElementById("result").textContent=`PALBI: ${score} (G${grade})`;
  ["z1","z2","z3"].forEach(id=>document.getElementById(id).classList.remove("active"));
  document.getElementById("z"+grade).classList.add("active");
  // Update stats
  stat.calc=(stat.calc||0)+1;
  stat.sumB=(stat.sumB||0)+bili; stat.sumA=(stat.sumA||0)+alb;
  stat.sumP=(stat.sumP||0)+plt;  stat.sumS=(stat.sumS||0)+score; saveStat();
  // Update history
  history.push({bili,alb,plt,score}); saveHist();
  // Update UI
  updateStats();
  if(!document.getElementById("history").hidden) updateHistory();
};

/* ---------- Stats table ---------- */
function updateStats(){
  const t=document.getElementById("statsTable");
  const cap=document.getElementById("tblCaption");
  t.hidden=false; cap.hidden=false;
  document.getElementById("vCount").textContent=stat.visits;
  document.getElementById("cCount").textContent=stat.calc||0;
  const avg=k=>stat.calc?(stat[k]/stat.calc).toFixed(2):"-";
  document.getElementById("avgBili").textContent=avg("sumB");
  document.getElementById("avgAlb").textContent=avg("sumA");
  document.getElementById("avgPlt").textContent=avg("sumP");
  document.getElementById("avgScore").textContent=avg("sumS");
  // Also update avgTable in history section
  document.getElementById("avgTable").hidden=false;
  document.getElementById("avgBili2").textContent=avg("sumB");
  document.getElementById("avgAlb2").textContent=avg("sumA");
  document.getElementById("avgPlt2").textContent=avg("sumP");
  document.getElementById("avgScore2").textContent=avg("sumS");
}

/* ---------- History listing with pagination ---------- */
const PAGE_SIZE=10;

document.getElementById("prevHist").onclick=()=>{if(currentHistPage<historyPages()-1){currentHistPage++;updateHistory();}};
document.getElementById("nextHist").onclick=()=>{if(currentHistPage>0){currentHistPage--;updateHistory();}};

function historyPages(){return Math.ceil(history.length/PAGE_SIZE);} // total pages

function updateHistory(){
  const list=document.getElementById("histList");
  list.innerHTML="";
  const total=history.length;
  // Determine slice indices (newest first)
  const start=total-PAGE_SIZE*(currentHistPage+1);
  const from=Math.max(0,start);
  const to=total-PAGE_SIZE*currentHistPage; // non‑inclusive
  const slice=history.slice(from,to);
  slice.forEach((x,idx)=>{
    const no=from+idx+1;
    list.insertAdjacentHTML("beforeend",`<li>${no}: Bili ${x.bili}, Alb ${x.alb}, Plt ${x.plt}, Score ${x.score}</li>`);
  });
  // nav buttons & range label
  const T=TXT[lang].histNav;
  const firstIdx=from+1, lastIdx=to;
  document.getElementById("histRange").textContent=T.range(firstIdx,lastIdx,total);
  document.getElementById("prevHist").disabled=currentHistPage>=historyPages()-1;
  document.getElementById("nextHist").disabled=currentHistPage===0;
  // Update avg table values (already updated in updateStats)
}

/* ---------- Initial population ---------- */
updateStats();
updateHistory();
</script>
</body>
</html>
