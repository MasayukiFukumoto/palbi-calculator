<!-- =======================  PALBI Calculator – one‑file v2025‑05 (fix4: formula & avg label) ======================= -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>PALBI 計算ツール / PALBI Calculator</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
 :root{--c1:#0066cc;--c2:#4caf50;--c3:#ff9800;--c4:#f44336;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif}
 body{max-width:720px;margin:auto;padding:1.5rem}
 h1{color:var(--c1);text-align:center;font-size:1.6rem;margin:0 0 1rem}
 nav{display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:1rem}
 nav button{flex:1 1 120px;border:1px solid var(--c1);background:#fff;color:#0066cc;padding:.4rem;border-radius:4px;cursor:pointer}
 nav button.active{background:var(--c1);color:#fff}
 label{display:block;margin-top:.8rem}
 input{width:160px;padding:.3rem}
 #calcBtn{margin-top:1rem;padding:.5rem 1.2rem;background:var(--c1);color:#fff;border:none;border-radius:4px;cursor:pointer}
 #zones{margin-top:1rem;text-align:center}
 .zone{display:inline-block;width:30%;padding:.4rem;font-weight:bold;color:#fff;border-radius:4px}
 #z1{background:var(--c2)}#z2{background:var(--c3)}#z3{background:var(--c4)}.active{box-shadow:0 0 14px 4px #000}
 table{border-collapse:collapse;margin-top:.4rem;width:100%}
 td,th{border:1px solid #ccc;padding:.3rem;text-align:center;font-size:.9rem}
 #histNav{display:flex;align-items:center;justify-content:center;gap:.6rem;margin:.6rem 0}
 #histNav button{border:1px solid var(--c1);background:#fff;color:#0066cc;padding:.2rem .6rem;border-radius:4px;cursor:pointer;min-width:64px}
 #histNav button:disabled{opacity:.4;cursor:default}
 footer{margin-top:1.5rem;font-size:.8rem;text-align:center;color:#555;line-height:1.4}
 @media print{nav,#calcBtn,#histNav{display:none}}
</style>
</head>
<body>
<h1 id="title">PALBI 計算ツール</h1>

<nav>
  <button data-page="calc"   class="active">計算</button>
  <button data-page="about">PALBIとは</button>
  <button data-page="refs">参考文献</button>
  <button data-page="history">履歴</button>
  <button id="langBtn">English</button>
</nav>

<!-- ===== 計算 ===== -->
<section id="calc" class="page">
  <label id="lb-bili">総ビリルビリン (mg/dL): <input type="number" id="bili" step="0.1" /></label>
  <label id="lb-alb">アルブミン (g/dL): <input type="number" id="alb" step="0.1" /></label>
  <label id="lb-plt">血小板数 (万/µL): <input type="number" id="plt" step="1" /></label>
  <button id="calcBtn">計算</button>

  <div id="result" style="margin-top:1rem;font-size:1.1rem"></div>

  <div id="zones">
    <div class="zone" id="z1">低値</div><div class="zone" id="z2">中間</div><div class="zone" id="z3">高値</div>
  </div>

  <!-- PALBI formula / note -->
  <p id="formula" style="margin-top:.8rem;font-size:.85rem"></p>
</section>

<!-- ===== PALBIとは ===== -->
<section id="about" class="page" hidden>
  <p id="about-text"></p>
</section>

<!-- ===== References ===== -->
<section id="refs" class="page" hidden>
  <ol style="font-size:.9rem">
    <li>Liu P‑H <em>et al.</em> Prognostic utility of the PALBI score for hepatocellular carcinoma resection. <em>J Gastroenterol Hepatol</em>. 2017;32:879‑886.</li>
    <li>Zhu M <em>et al.</em> PALBI stratification in cirrhosis. <em>Eur J Gastroenterol Hepatol</em>. 2020;32:1698‑1705.</li>
    <li>Lee S‑K <em>et al.</em> Validating PALBI in Asian cohorts. <em>PLoS ONE</em>. 2019;14:e0216173.</li>
  </ol>
</section>

<!-- ===== 履歴 ===== -->
<section id="history" class="page" hidden>
  <div id="histNav"><button id="prevHist">&lt; Prev</button><span id="histRange"></span><button id="nextHist">Next &gt;</button></div>
  <ol id="histList" style="font-size:.9rem"></ol>

  <p id="tblCaption" hidden></p>
  <table id="statsTable" hidden>
    <thead><tr><th></th><th id="th-vis"></th><th id="th-calc"></th><th id="th-avg"></th></tr></thead>
    <tbody>
      <tr><td id="td-bili"></td><td colspan="2"></td><td id="avgBili"></td></tr>
      <tr><td id="td-alb"></td><td colspan="2"></td><td id="avgAlb"></td></tr>
      <tr><td id="td-plt"></td><td colspan="2"></td><td id="avgPlt"></td></tr>
      <tr><td>PALBI</td><td id="vCount"></td><td id="cCount"></td><td id="avgScore"></td></tr>
    </tbody>
  </table>

  <p id="avgCaption" style="font-size:.85rem;color:#333;margin-top:.6rem"></p>
  <table id="avgTable" hidden>
    <thead><tr><th></th><th id="th-avgBili"></th><th id="th-avgAlb"></th><th id="th-avgPlt"></th><th id="th-avgScore">PALBI</th></tr></thead>
    <tbody><tr><td id="avgRowLabel"></td><td id="avgBili2"></td><td id="avgAlb2"></td><td id="avgPlt2"></td><td id="avgScore2"></td></tr></tbody>
  </table>
</section>

<footer id="footer"></footer>

<script>
/* ---------- Storage ---------- */
const KEY_HIST = "palbiHist", KEY_STAT = "palbiStat";
let histData = JSON.parse(localStorage.getItem(KEY_HIST) || "[]");
let stat     = JSON.parse(localStorage.getItem(KEY_STAT) || "{}");
stat.visits  = (stat.visits || 0) + 1; saveStat();
function saveStat(){ localStorage.setItem(KEY_STAT, JSON.stringify(stat)); }
function saveHist(){ localStorage.setItem(KEY_HIST, JSON.stringify(histData)); }

/* ---------- State ---------- */
let lang = localStorage.getItem("palbiLang") || "jp";
let currentHistPage = 0;

/* ---------- Dictionary ---------- */
const TXT = {
  jp: {
    menu:{calc:"計算",about:"PALBIとは",refs:"参考文献",history:"履歴"},
    title:"PALBI 計算ツール",
    labels:{bili:"総ビリルビリン (mg/dL):",alb:"アルブミン (g/dL):",plt:"血小板数 (万/µL):"},
    btnCalc:"計算",low:"低値",mid:"中間",high:"高値",
    about:`PALBI (Platelet‑Albumin‑Bilirubin) スコアは、肝障害の重症度や予後を評価する指標です。<br>血小板・アルブミン・ビリルビンの 3 項目で算出し、値が低いほど肝機能が良好とされます。`,
    formula:`PALBI = 2.02 × log10 B – 0.37 × (log10 B)² – 0.04 × A – 3.48 × log10 P + 1.01 × (log10 P)²<br><small>※ 入力した血小板数 (万/µL) は内部で ×10³/µL に換算して計算されます。</small>`,
    tbl:{login:"ログイン履歴",calc:"計算履歴",avg:"平均",bili:"ビリルビン",alb:"アルブミン",plt:"血小板数",avgCaption:"計算回数あたりの平均値"},
    histNav:{prev:"< 前",next:"次 >",range:(a,b,c)=>`${a}-${b} / ${c}`},
    langBtn:"English",alertFill:"値を全て入力してください",
    footer:`長崎大学肝臓外科版 PALBI計算ツール v2025‑05 (fix4)<br>© 福本将之、江口 晋`
  },
  en: {
    menu:{calc:"Calculator",about:"About PALBI",refs:"References",history:"History"},
